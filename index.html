<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Prevent mobile zoom quirks; keep inputs >=16px to avoid iOS zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>- Modern Social Media Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    html, body { height: 100%; }
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .post-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    /* Inputs >= 16px to avoid mobile zoom */
    input, textarea, button, select { font-size: 16px; }
    /* Image aspect */
    .post-img { width: 100%; border-radius: 12px; object-fit: cover; max-height: 480px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="toast-container" style="position: fixed; top: env(safe-area-inset-top, 20px); right: 20px; z-index: 9999;"></div>

  <script type="text/babel">
    // ==========================
    // Supabase Configuration
    // ==========================
    const supabaseUrl = 'https://rzbrlrkigfdwqrrlpbuq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6YnJscmtpZ2Zkd3FycmxwYnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNTc0NTEsImV4cCI6MjA3MTkzMzQ1MX0.JLAlo06HXzNZeOlIB3Hla4kDDFutd2Jye8ImqWraNsM';
    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const { useState, useEffect, useContext, createContext, useRef, useMemo } = React;

    // ==========================
    // Toast
    // ==========================
    window.showToast = function(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
      toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 transform transition-all duration-300 translate-x-full opacity-0`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); }, 80);
      setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => container.removeChild(toast), 300);
      }, 3000);
    };

    // ==========================
    // Helpers
    // ==========================
    const fmtTime = (iso) => { try { return new Date(iso).toLocaleString(); } catch { return 'Just now'; } };
    const nonEmpty = (s) => (s || '').trim().length > 0;
    const EMOJIS = ['🤣','😍','😥','🥰','😴','😒','😭','😠','🤡'];

    // ==========================
    // Auth Context
    // ==========================
    const AuthContext = createContext();

    const upsertProfile = async (user) => {
      if (!user) return;
      const displayName =
        user.user_metadata?.display_name ||
        user.email?.split('@')[0] ||
        'User';
      const { error } = await supabaseClient.from('profiles').upsert({
        id: user.id,
        display_name: displayName,
      });
      if (error) console.warn('profile upsert error:', error.message);
    };

    const AuthProvider = ({ children }) => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setLoading(false);
          if (session?.user) upsertProfile(session.user);
        });

        const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
          async (_event, session) => {
            setUser(session?.user ?? null);
            setLoading(false);
            if (session?.user) upsertProfile(session.user);
          }
        );
        return () => subscription.unsubscribe();
      }, []);

      const signUp = async (email, password, displayName) => {
        try {
          const { data, error } = await supabaseClient.auth.signUp({
            email,
            password,
            options: { data: { display_name: displayName } }
          });
          if (error) throw error;
          showToast('Account created successfully!', 'success');
          if (data?.user) await upsertProfile(data.user);
          return data;
        } catch (e) { showToast(e.message, 'error'); throw e; }
      };

      const signIn = async (email, password) => {
        try {
          const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
          if (error) throw error;
          showToast('Successfully signed in!', 'success');
          if (data?.user) await upsertProfile(data.user);
          return data;
        } catch (e) { showToast(e.message, 'error'); throw e; }
      };

      const signOut = async () => {
        try {
          const { error } = await supabaseClient.auth.signOut();
          if (error) throw error;
          showToast('Successfully signed out!', 'success');
        } catch (e) { showToast(e.message, 'error'); }
      };

      return (
        <AuthContext.Provider value={{user, signUp, signIn, signOut}}>
          {!loading && children}
        </AuthContext.Provider>
      );
    };
    const useAuth = () => useContext(AuthContext);

    // ==========================
    // Storage helper for post images
    // ==========================
    async function uploadPostImage(file, userId) {
      const path = `${userId}/${Date.now()}_${file.name}`.replaceAll(' ', '_');
      const { data, error } = await supabaseClient
        .storage.from('post-images')
        .upload(path, file, { cacheControl: '3600', upsert: false, contentType: file.type || 'image/jpeg' });
      if (error) throw error;
      const { data: pub } = supabaseClient.storage.from('post-images').getPublicUrl(data.path);
      return pub.publicUrl;
    }

    // ==========================
    // Navbar
    // ==========================
    const Navbar = ({ currentPage, setCurrentPage }) => {
      const { user, signOut } = useAuth();
      return (
        <nav className="glass rounded-lg p-4 mb-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                <span className="text-white font-bold text-sm">GS</span>
              </div>
              <div>
                <h1 className="text-white text-xl font-bold leading-tight">Modern social platform</h1>
                <p className="text-white/70 text-xs -mt-0.5">by talha</p>
              </div>
            </div>

            {user && (
              <div className="flex items-center space-x-2">
                <button onClick={() => setCurrentPage('feed')}
                  className={`px-3 py-2 rounded-lg transition-all ${currentPage==='feed'?'bg-white/20 text-white':'text-white/70 hover:text-white hover:bg-white/10'}`}>
                  Feed
                </button>
                <button onClick={() => setCurrentPage('chat')}
                  className={`px-3 py-2 rounded-lg transition-all ${currentPage==='chat'?'bg-white/20 text-white':'text-white/70 hover:text-white hover:bg-white/10'}`}>
                  Chat
                </button>
                <button onClick={() => setCurrentPage('profile')}
                  className={`px-3 py-2 rounded-lg transition-all ${currentPage==='profile'?'bg-white/20 text-white':'text-white/70 hover:text-white hover:bg-white/10'}`}>
                  Profile
                </button>
                <button onClick={signOut}
                  className="px-3 py-2 bg-red-500/20 text-white rounded-lg hover:bg-red-500/30 transition-all">
                  Sign Out
                </button>
              </div>
            )}
          </div>
        </nav>
      );
    };

    // ==========================
    // Login Form
    // ==========================
    const LoginForm = () => {
      const [isSignUp, setIsSignUp] = useState(false);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [name, setName] = useState('');
      const [loading, setLoading] = useState(false);
      const { signUp, signIn } = useAuth();

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          if (isSignUp) {
            await signUp(email, password, name);
          } else {
            await signIn(email, password);
          }
          setEmail(''); setPassword(''); setName('');
        } catch (error) { /* toast already shown */ }
        setLoading(false);
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <span className="text-white font-bold text-2xl">GS</span>
              </div>
              <h2 className="text-2xl font-bold text-white mb-2">
                {isSignUp ? 'Join Glassy Social' : 'Welcome Back'}
              </h2>
              <p className="text-white/70">
                {isSignUp ? 'Create your account to get started' : 'Sign in to your account'}
              </p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              {isSignUp && (
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Full Name"
                  className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  required
                />
              )}
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Email"
                className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                required
                inputMode="email"
              />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Password"
                className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                required
              />
              <button
                type="submit"
                disabled={loading}
                className="w-full btn-primary text-white py-3 rounded-lg font-medium disabled:opacity-50"
              >
                {loading ? 'Loading...' : (isSignUp ? 'Sign Up' : 'Sign In')}
              </button>
            </form>

            <div className="mt-6 text-center">
              <button
                onClick={() => setIsSignUp(!isSignUp)}
                className="text-white/70 hover:text-white transition-colors"
              >
                {isSignUp ? 'Already have an account? Sign In' : 'Need an account? Sign Up'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ==========================
    // Reaction Bar (per post)
    // ==========================
    const ReactionBar = ({ postId, currentUserId }) => {
      const [counts, setCounts] = useState({}); // { '🤣': 3, ... }
      const [myReacts, setMyReacts] = useState(new Set()); // emojis I reacted with

      const loadReactions = async () => {
        const { data, error } = await supabaseClient
          .from('post_reactions')
          .select('emoji, user_id')
          .eq('post_id', postId);
        if (error) { console.warn(error.message); return; }
        const c = {};
        const mine = new Set();
        (data || []).forEach(r => {
          c[r.emoji] = (c[r.emoji] || 0) + 1;
          if (r.user_id === currentUserId) mine.add(r.emoji);
        });
        setCounts(c);
        setMyReacts(mine);
      };

      useEffect(() => {
        loadReactions();
        // realtime
        const channel = supabaseClient
          .channel(`public:post_reactions:${postId}`)
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'post_reactions', filter: `post_id=eq.${postId}` },
            (_payload) => { loadReactions(); }
          )
          .subscribe();
        return () => supabaseClient.removeChannel(channel);
      }, [postId]);

      const toggle = async (emoji) => {
        if (!currentUserId) return;
        // if already reacted with this emoji => remove; else add
        if (myReacts.has(emoji)) {
          const { error } = await supabaseClient
            .from('post_reactions')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', currentUserId)
            .eq('emoji', emoji);
          if (error) showToast(error.message, 'error');
        } else {
          const { error } = await supabaseClient
            .from('post_reactions')
            .insert({ post_id: postId, user_id: currentUserId, emoji });
          if (error) showToast(error.message, 'error');
        }
      };

      return (
        <div className="flex flex-wrap gap-2 mt-2">
          {EMOJIS.map(e => {
            const active = myReacts.has(e);
            const count = counts[e] || 0;
            return (
              <button
                key={e}
                onClick={() => toggle(e)}
                className={`px-2.5 py-1 rounded-full text-sm border transition ${
                  active ? 'bg-white/30 border-white/60 text-white' : 'bg-white/10 border-white/30 text-white/90 hover:bg-white/20'
                }`}
                title={active ? 'Remove reaction' : 'Add reaction'}
              >
                <span className="align-middle">{e}</span>
                <span className="ml-1 align-middle">{count > 0 ? count : ''}</span>
              </button>
            );
          })}
        </div>
      );
    };

    // ==========================
    // Feed: CRUD + Comments + Realtime + Image Upload + Reactions
    // ==========================
    const Feed = () => {
      const { user } = useAuth();
      const [posts, setPosts] = useState([]);
      const [newPost, setNewPost] = useState('');
      const [loading, setLoading] = useState(true);
      const [editingId, setEditingId] = useState(null);
      const [editingText, setEditingText] = useState('');
      const [file, setFile] = useState(null);
      const [uploading, setUploading] = useState(false);

      const authorName = () => (user?.user_metadata?.display_name) || user?.email || 'User';

      const loadPosts = async () => {
        setLoading(true);
        const { data, error } = await supabaseClient
          .from('posts')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);
        if (error) { showToast(error.message, 'error'); }
        else { setPosts(data || []); }
        setLoading(false);
      };

      useEffect(() => {
        loadPosts();

        // Realtime: posts
        const channelPosts = supabaseClient
          .channel('public:posts')
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'posts' },
            (payload) => {
              if (payload.eventType === 'INSERT') {
                setPosts((prev) => [payload.new, ...prev]);
              } else if (payload.eventType === 'UPDATE') {
                setPosts((prev) => prev.map(p => p.id === payload.new.id ? payload.new : p));
              } else if (payload.eventType === 'DELETE') {
                setPosts((prev) => prev.filter(p => p.id !== payload.old.id));
              }
            }
          )
          .subscribe();

        // Realtime: comments
        const channelComments = supabaseClient
          .channel('public:comments')
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'comments' },
            (payload) => {
              window.dispatchEvent(new CustomEvent('comments-changed', { detail: payload }));
            }
          )
          .subscribe();

        return () => {
          supabaseClient.removeChannel(channelPosts);
          supabaseClient.removeChannel(channelComments);
        };
      }, []);

      const handlePost = async (e) => {
        e.preventDefault();
        if (!nonEmpty(newPost) && !file) { showToast('Write something or add a photo.', 'info'); return; }
        setUploading(true);
        try {
          let image_url = null;
          if (file) {
            image_url = await uploadPostImage(file, user.id);
          }
          const { error } = await supabaseClient.from('posts').insert({
            author_id: user.id,
            author_name: authorName(),
            content: (newPost || '').trim(),
            image_url
          });
          if (error) throw error;
          showToast('Post created!', 'success');
          setNewPost('');
          setFile(null);
          e.target.reset?.(); // clear file input visually
        } catch (err) {
          showToast(err.message, 'error');
        }
        setUploading(false);
      };

      const startEdit = (post) => {
        setEditingId(post.id);
        setEditingText(post.content || '');
      };

      const saveEdit = async (id) => {
        const payload = { content: (editingText || '').trim() };
        const { error } = await supabaseClient.from('posts').update(payload).eq('id', id);
        if (error) showToast(error.message, 'error');
        else { showToast('Post updated!', 'success'); setEditingId(null); setEditingText(''); }
      };

      const cancelEdit = () => { setEditingId(null); setEditingText(''); };

      const deletePost = async (id) => {
        if (!confirm('Delete this post?')) return;
        const { error } = await supabaseClient.from('posts').delete().eq('id', id);
        if (error) showToast(error.message, 'error');
        else showToast('Post deleted', 'success');
      };

      return (
        <div className="max-w-2xl mx-auto">
          {/* Post Composer */}
          <div className="post-card rounded-2xl p-6 mb-6">
            <form onSubmit={handlePost}>
              <textarea
                value={newPost}
                onChange={(e) => setNewPost(e.target.value)}
                placeholder="What's on your mind?"
                className="w-full bg-transparent text-white placeholder-white/50 resize-none focus:outline-none text-lg"
                rows="3"
              />
              <div className="mt-3 flex items-center gap-3">
                <label className="cursor-pointer inline-flex items-center px-3 py-2 rounded-lg bg-white/10 text-white border border-white/20 hover:bg-white/20">
                  <input type="file" accept="image/*" className="hidden" onChange={(e) => setFile(e.target.files?.[0] || null)} />
                  📷 <span className="ml-2">{file ? file.name : 'Add Photo'}</span>
                </label>
                <div className="flex-1"></div>
                <button type="submit" disabled={uploading}
                  className="btn-primary px-6 py-2 rounded-lg text-white font-medium disabled:opacity-50">
                  {uploading ? 'Uploading…' : 'Post'}
                </button>
              </div>
            </form>
          </div>

          {/* Posts */}
          {loading ? (
            <div className="text-white/80 text-center">Loading posts…</div>
          ) : posts.length === 0 ? (
            <div className="post-card rounded-2xl p-6 mb-6 text-center text-white/80">
              No posts yet. Be the first! 🎉
            </div>
          ) : (
            posts.map(post => (
              <div key={post.id} className="post-card rounded-2xl p-6 mb-6">
                <div className="flex items-center mb-4">
                  <div className="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                    <span className="text-white font-bold text-sm">
                      {(post.author_name || 'U').charAt(0).toUpperCase()}
                    </span>
                  </div>
                  <div className="ml-3">
                    <p className="text-white font-medium break-all">{post.author_name || 'User'}</p>
                    <p className="text-white/50 text-sm">{fmtTime(post.created_at)}</p>
                  </div>
                </div>

                {/* Image */}
                {post.image_url && (
                  <div className="mb-3">
                    <img loading="lazy" src={post.image_url} alt="Post" className="post-img border border-white/20" />
                  </div>
                )}

                {/* Content OR Edit Mode */}
                {editingId === post.id ? (
                  <div className="mb-3">
                    <textarea
                      value={editingText}
                      onChange={(e) => setEditingText(e.target.value)}
                      className="w-full bg-white/10 border border-white/20 rounded-lg text-white p-3"
                      rows="3"
                    />
                    <div className="flex gap-2 mt-2">
                      <button onClick={() => saveEdit(post.id)} className="px-4 py-2 rounded-lg bg-green-500 text-white">Save</button>
                      <button onClick={cancelEdit} className="px-4 py-2 rounded-lg bg-gray-500/50 text-white">Cancel</button>
                    </div>
                  </div>
                ) : (
                  <p className="text-white text-lg mb-2 whitespace-pre-wrap break-words">{post.content}</p>
                )}

                {/* Reactions */}
                <ReactionBar postId={post.id} currentUserId={user?.id} />

                {/* Owner actions */}
                {user?.id === post.author_id && editingId !== post.id && (
                  <div className="flex items-center gap-4 my-3">
                    <button onClick={() => startEdit(post)} className="text-blue-300 hover:text-blue-200">Edit</button>
                    <button onClick={() => deletePost(post.id)} className="text-red-300 hover:text-red-200">Delete</button>
                  </div>
                )}

                {/* Comments */}
                <Comments postId={post.id} />
              </div>
            ))
          )}
        </div>
      );
    };

    // ==========================
    // Comments: CRUD + Realtime
    // ==========================
    const Comments = ({ postId }) => {
      const { user } = useAuth();
      const [comments, setComments] = useState([]);
      const [newComment, setNewComment] = useState('');
      const [editingId, setEditingId] = useState(null);
      const [editingText, setEditingText] = useState('');

      const authorName = () => (user?.user_metadata?.display_name) || user?.email || 'User';

      const load = async () => {
        const { data, error } = await supabaseClient
          .from('comments')
          .select('*')
          .eq('post_id', postId)
          .order('created_at', { ascending: true });
        if (error) showToast(error.message, 'error');
        else setComments(data || []);
      };

      useEffect(() => { load(); }, [postId]);

      useEffect(() => {
        const handler = (ev) => {
          const payload = ev.detail;
          if (payload.table !== 'comments') return;
          const row = payload.new || payload.old;
          if (!row || row.post_id !== postId) return;

          if (payload.eventType === 'INSERT') {
            setComments((prev) => [...prev, payload.new]);
          } else if (payload.eventType === 'UPDATE') {
            setComments((prev) => prev.map(c => c.id === payload.new.id ? payload.new : c));
          } else if (payload.eventType === 'DELETE') {
            setComments((prev) => prev.filter(c => c.id !== payload.old.id));
          }
        };
        window.addEventListener('comments-changed', handler);
        return () => window.removeEventListener('comments-changed', handler);
      }, [postId]);

      const addComment = async (e) => {
        e.preventDefault();
        if (!nonEmpty(newComment)) return;
        const { error } = await supabaseClient.from('comments').insert({
          post_id: postId,
          author_id: user.id,
          author_name: authorName(),
          content: newComment.trim()
        });
        if (error) showToast(error.message, 'error');
        else setNewComment('');
      };

      const startEdit = (c) => { setEditingId(c.id); setEditingText(c.content); };
      const saveEdit = async (id) => {
        if (!nonEmpty(editingText)) return;
        const { error } = await supabaseClient.from('comments').update({ content: editingText.trim() }).eq('id', id);
        if (error) showToast(error.message, 'error');
        else { showToast('Comment updated!', 'success'); setEditingId(null); setEditingText(''); }
      };
      const cancelEdit = () => { setEditingId(null); setEditingText(''); };
      const deleteComment = async (id) => {
        if (!confirm('Delete this comment?')) return;
        const { error } = await supabaseClient.from('comments').delete().eq('id', id);
        if (error) showToast(error.message, 'error');
        else showToast('Comment deleted', 'success');
      };

      return (
        <div className="mt-4">
          <h3 className="text-white/80 mb-2 font-medium">Comments</h3>

          {comments.length === 0 ? (
            <div className="text-white/60 mb-3">No comments yet.</div>
          ) : (
            <div className="space-y-2 mb-3">
              {comments.map(c => (
                <div key={c.id} className="bg-white/10 p-3 rounded-lg text-white">
                  <div className="flex items-start justify-between">
                    <div className="min-w-0">
                      <div className="font-medium break-all">{c.author_name || 'User'}</div>
                      <div className="text-xs text-white/60">{fmtTime(c.created_at)}</div>
                    </div>
                    {user?.id === c.author_id && editingId !== c.id && (
                      <div className="flex gap-3 text-sm">
                        <button onClick={() => startEdit(c)} className="text-blue-300 hover:text-blue-200">Edit</button>
                        <button onClick={() => deleteComment(c.id)} className="text-red-300 hover:text-red-200">Delete</button>
                      </div>
                    )}
                  </div>

                  {editingId === c.id ? (
                    <div className="mt-2">
                      <textarea
                        value={editingText}
                        onChange={(e) => setEditingText(e.target.value)}
                        className="w-full bg-white/10 border border-white/20 rounded-lg text-white p-2"
                        rows="2"
                      />
                      <div className="flex gap-2 mt-2">
                        <button onClick={() => saveEdit(c.id)} className="px-3 py-1 rounded bg-green-500 text-white text-sm">Save</button>
                        <button onClick={cancelEdit} className="px-3 py-1 rounded bg-gray-500/50 text-white text-sm">Cancel</button>
                      </div>
                    </div>
                  ) : (
                    <p className="mt-2 whitespace-pre-wrap break-words">{c.content}</p>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* Add comment */}
          <form onSubmit={addComment} className="flex gap-2">
            <input
              type="text"
              value={newComment}
              onChange={(e) => setNewComment(e.target.value)}
              placeholder="Write a comment..."
              className="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
            />
            <button type="submit" className="btn-primary px-4 py-2 rounded-lg text-white">
              Send
            </button>
          </form>
        </div>
      );
    };

    // ==========================
    // Chat (DB-backed + realtime)
    // ==========================
    const Chat = () => {
      const { user } = useAuth();
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const listRef = useRef(null);

      const load = async () => {
        const { data, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('created_at', { ascending: true })
          .limit(500);
        if (error) { showToast(error.message, 'error'); return; }
        setMessages(data || []);
        requestAnimationFrame(() => {
          listRef.current?.scrollTo({ top: listRef.current.scrollHeight, behavior: 'instant' });
        });
      };

      useEffect(() => {
        load();
        const channel = supabaseClient
          .channel('public:messages')
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'messages' },
            (payload) => {
              if (payload.eventType === 'INSERT') {
                setMessages(prev => [...prev, payload.new]);
                requestAnimationFrame(() => {
                  listRef.current?.scrollTo({ top: listRef.current.scrollHeight, behavior: 'smooth' });
                });
              } else if (payload.eventType === 'DELETE') {
                setMessages(prev => prev.filter(m => m.id !== payload.old.id));
              } else if (payload.eventType === 'UPDATE') {
                setMessages(prev => prev.map(m => m.id === payload.new.id ? payload.new : m));
              }
            }
          ).subscribe();
        return () => supabaseClient.removeChannel(channel);
      }, []);

      const handleSend = async (e) => {
        e.preventDefault();
        if (!nonEmpty(newMessage)) return;
        const { error } = await supabaseClient.from('messages').insert({
          author_id: user.id,
          author_name: user.user_metadata?.display_name || user.email,
          content: newMessage.trim()
        });
        if (error) showToast(error.message, 'error');
        else setNewMessage('');
      };

      return (
        <div className="max-w-4xl mx-auto">
          <div className="glass rounded-2xl p-6 h-[70vh] mb-4 flex flex-col">
            <div ref={listRef} className="flex-1 overflow-y-auto space-y-4 mb-4 pr-1">
              {messages.length === 0 ? (
                <div className="text-white/70">Welcome to Glassy Social Chat!</div>
              ) : messages.map(message => (
                <div key={message.id} className={`rounded-lg p-3 ${message.author_id===user.id ? 'bg-white/20 ml-auto' : 'bg-white/10'}`} style={{maxWidth:'85%'}}>
                  <div className="flex justify-between items-start mb-1">
                    <span className="text-white/90 font-medium break-all">{message.author_name || 'User'}</span>
                    <span className="text-white/60 text-xs ml-2 whitespace-nowrap">{fmtTime(message.created_at)}</span>
                  </div>
                  <p className="text-white break-words">{message.content}</p>
                </div>
              ))}
            </div>
            <form onSubmit={handleSend} className="flex space-x-3">
              <input
                type="text"
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                placeholder="Type a message..."
                className="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
              <button type="submit" className="btn-primary px-6 py-2 rounded-lg text-white font-medium">
                Send
              </button>
            </form>
          </div>
        </div>
      );
    };

    // ==========================
    // Profile (Edit: display_name + bio) — fixed
    // ==========================
    const Profile = () => {
      const { user } = useAuth();
      const [displayName, setDisplayName] = useState('');
      const [bio, setBio] = useState('');
      const [loading, setLoading] = useState(true);

      const load = async () => {
        if (!user) return;
        const { data, error } = await supabaseClient
          .from('profiles').select('*').eq('id', user.id).maybeSingle();
        if (error) { showToast(error.message, 'error'); setLoading(false); return; }
        setDisplayName(data?.display_name || (user.email?.split('@')[0] ?? ''));
        setBio(data?.bio || '');
        setLoading(false);
      };

      useEffect(() => { load(); }, [user?.id]);

      const save = async () => {
        const payload = {
          id: user.id,
          display_name: (displayName || '').trim(),
          bio: (bio || '').trim()
        };
        const { error } = await supabaseClient.from('profiles').upsert(payload).select().single();
        if (error) showToast(error.message, 'error');
        else showToast('Profile updated!', 'success');
      };

      if (loading) return <div className="text-white/80 text-center">Loading profile…</div>;

      return (
        <div className="max-w-4xl mx-auto">
          <div className="glass rounded-2xl p-8">
            <div className="flex items-center space-x-6 mb-8">
              <div className="w-24 h-24 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                <span className="text-white font-bold text-3xl">
                  {(displayName || user?.email || 'U').charAt(0).toUpperCase()}
                </span>
              </div>
              <div>
                <h1 className="text-3xl font-bold text-white mb-2">Edit Profile</h1>
                <p className="text-white/70">Update your public info</p>
              </div>
            </div>

            <div className="grid gap-4">
              <div>
                <label className="block text-white/80 mb-1">Display Name</label>
                <input
                  type="text"
                  value={displayName}
                  onChange={(e) => setDisplayName(e.target.value)}
                  className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="Your name"
                />
              </div>
              <div>
                <label className="block text-white/80 mb-1">Bio</label>
                <textarea
                  value={bio}
                  onChange={(e) => setBio(e.target.value)}
                  className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  rows="4"
                  placeholder="Tell people about yourself"
                />
              </div>
              <div className="flex justify-end">
                <button onClick={save} className="btn-primary px-6 py-2 rounded-lg text-white font-medium">
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==========================
    // Main App
    // ==========================
    const App = () => {
      const [currentPage, setCurrentPage] = useState('feed');
      const { user } = useAuth();

      if (!user) { return <LoginForm />; }

      const renderPage = () => {
        switch (currentPage) {
          case 'chat': return <Chat />;
          case 'profile': return <Profile />;
          default: return <Feed />;
        }
      };

      return (
        <div className="min-h-screen p-4">
          <div className="max-w-6xl mx-auto">
            <Navbar currentPage={currentPage} setCurrentPage={setCurrentPage} />
            {renderPage()}
          </div>
        </div>
      );
    };

    const AppRoot = () => (
      <AuthProvider>
        <App />
      </AuthProvider>
    );

    ReactDOM.render(<AppRoot />, document.getElementById('root'));
  </script>
</body>
</html>
